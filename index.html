<!doctype html>
<html>
  <head>
    <script src="http://fb.me/react-0.10.0.js"></script>
    <style>
      .game {
        border: 4px solid black;
        margin: 16px;
      }
      
      .game-red {
        border-bottom: 16px solid red;
      }
      
      .game-green {
        border-bottom: 16px solid green;
      }
    </style>
  </head>
  <body>
    <script>
      "use strict";
      
      function erf(x) {
        if(x >= 0) {
          return 1 - 1 / Math.pow(1 + 0.278393*x + 0.230389*x*x + 0.000972*x*x*x + 0.078108*x*x*x*x, 4);
        }
        return -erf(-x);
      }
      
      function los(wins, losses) {
        var sum = wins + losses
        if(sum > 0) {
          return 0.5 * (1 + erf((wins - losses) / Math.sqrt(2 * sum)));
        }
        return 0;
      }
      
      var dirs = {
        'up': -101,
        'down': 101,
        'left': -1,
        'right': 1
      };
      
      function Game(file1, file2) {
        var self = this;
        var field = new Uint8Array(101*102);
        var i;
        for(i = 0; i < 101; ++i) {
          field[i] = 3;
          field[i+101*101] = 3;
          field[201+i*101] = 3;
        }
        var stepsLeft = 10000;
        var workers = [new GameWorker(1, file1), new GameWorker(2, file2)];
        
        function endGame() {
          if(self.onResult) {
            self.onResult(workers[0].score, workers[1].score, field);
          }
          self.terminate();
        }
        
        self.terminate = function() {
          for(var i = 0; i < 2; ++i) {
            if(workers[i]) {
              workers[i].terminate();
              workers[i] = null;
            }
          }
        }
        
        function GameWorker(index, file) {
          var self = this;
          var x = Math.floor(Math.random() * 100);
          var y = Math.floor(Math.random() * 100);
          var pos = x + (y + 1) * 101;
          field[pos] = index;
          self.score = 1;
          
          var url = window.URL.createObjectURL(file);
          var worker = new Worker(url);
          window.URL.revokeObjectURL(url);
          
          self.terminate = function() {
            worker.terminate();
          };
          
          var id = 1;
          
          worker.onmessage = function(event) {
            if(--stepsLeft < 0) {
              endGame();
            } else if(event.data.id === id) {
              id = Math.random();
              var d = dirs[event.data.direction];
              if(d) {
                var newPos = pos + d;
                var f = field[newPos];
                var done = false;
                if(f === 0 || f === index) {
                  if(f === 0) {
                    self.score += 1;
                  }
                  pos = newPos;
                  field[pos] = index;
                  done = true;
                }
                worker.postMessage({id: id, done: done});
              }
            }
          };
          
          worker.postMessage({id: id});
        }
      }
      
      function Match(file1, file2) {
        var self = this;
        var game = null;
        var score = [0, 0];
        
        startNewGame();
        
        function startNewGame() {
          if(game) {
            game.terminate();
          }
          game = new Game(file1, file2);
          game.onResult = function(score1, score2, field) {
            if(score1 > score2) {
              score[0]++;
            } else {
              score[1]++;
            }
            if(self.onScoreChange) {
              self.onScoreChange(score, {field: field, score1: score1, score2: score2});
            }
            startNewGame();
          }
        }
        
        self.stop = function() {
          if(game) {
            game.terminate();
            game = null;
          }
        };
        
        self.isStopped = function() { return game === null; }
      }
      
      var GameView = React.createClass({
        draw: function() {
          var ctx = this.refs.canvas.getDOMNode().getContext('2d');
          var imageData = ctx.getImageData(0, 0, 100, 100);
          var data = imageData.data;
          var field = this.props.field;
          var i1 = 101;
          var i2 = 0;
          for(var y = 0; y < 100; ++y) {
            for(var x = 0; x < 100; ++x) {
              switch(field[i1]) {
                case 0:
                  data[i2+0] = 192;
                  data[i2+1] = 192;
                  data[i2+2] = 192;
                  break;
                case 1:
                  data[i2+0] = 255;
                  data[i2+1] = 128;
                  data[i2+2] = 128;
                  break;
                case 2:
                  data[i2+0] = 128;
                  data[i2+1] = 255;
                  data[i2+2] = 128;
                  break;
              }
              data[i2 + 3] = 255;
              i2 += 4;
              i1++;
            }
            i1++;
          }
          ctx.putImageData(imageData, 0, 0);
        },
        componentDidMount: function() { this.draw(); },
        componentDidUpdate: function() { this.draw(); },
        render: function() {
          return React.DOM.canvas({
            className: this.props.score1 > this.props.score2 ? 'game game-red' : 'game game-green',
            width: 100, height: 100, key: this.props.id, ref: 'canvas'});
        }
      });
      
      var MatchView = React.createClass({
        getInitialState: function() {
          return {gameId: 0, fields: []};
        },
        start: function() {
          var match = new Match(this.props.file1, this.props.file2);
          this.setState({match: match, score: [0, 0], gameId: 0, fields: []});
          match.onScoreChange = this.scoreChange;
        },
        stop: function() {
          this.state.match.stop();
          this.setState({match: null, score: this.state.score});
        },
        scoreChange: function(score, gameData) {
          var fields = this.state.fields;
          fields[this.state.gameId % 20] = {id: this.state.gameId++, field: gameData.field, score1: gameData.score1, score2: gameData.score2};
          this.setState({score: score, fields: fields});
        },
        render: function() {
          if(!this.props.file1 || !this.props.file2) {
            return React.DOM.div({children: 'waiting for files'});
          } else if(this.state.match) {
            this.state.match.onScoreChange = this.scoreChange;
            return React.DOM.div({children: [
              this.state.score[0] + ' - ' + this.state.score[1] +
                ' (LOS ' + (los(this.state.score[0], this.state.score[1]) * 100).toFixed(2) + '%)',
              React.DOM.button({
                type: 'button',
                onClick: this.stop,
                children: 'Stop'
              }),
              React.DOM.div({children: this.state.fields.map(function(f) { return GameView(f); })})
            ]});
          }
          return React.DOM.button({
            type: 'button',
            onClick: this.start,
            children: 'Start'
          });
        }
      });
      
      var FileSelector = React.createClass({
        handleChange: function(event) {
          if(this.props.onChange) {
            this.props.onChange(event.target.files[0]);
          }
        },
        render: function() {
          return React.DOM.div({children: [
            React.DOM.input({type: 'file', onChange: this.handleChange})
          ]});
        }
      });
    
      var Runner = React.createClass({
        getInitialState: function() {
          return {file1: null, file2: null};
        },
        handleFileChange: function(key, file) {
          var o = {};
          o[key] = file;
          this.setState(o);
        },
        render: function() {
          return React.DOM.div({children: [
            FileSelector({onChange: this.handleFileChange.bind(this, 'file1')}),
            FileSelector({onChange: this.handleFileChange.bind(this, 'file2')}),
            MatchView(this.state),
          ]});
        }
      });
      React.renderComponent(Runner({}), document.body);
    </script>
  </body>
</html>
