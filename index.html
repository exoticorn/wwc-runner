<!doctype html>
<html>
  <head>
    <script src="http://fb.me/react-0.10.0.js"></script>
    <style>
      .workers {
        border: 1px solid rgba(0, 0, 0, 0.2);
        margin: 8px;
        padding: 4px;
      }
    
      .game {
        display: inline-block;
        margin: 16px;
        line-height: 0px;
        cursor: pointer;
      }
    
      .game-view {
        border: 2px solid black;
      }
      
      .name {
        margin: 4px;
        font-size: 140%;
      }
      
      .match-score {
        margin: 4px;
        font-size: 170%;
      }
      
      .game-result {
        position: relative;
        border: 1px solid black;
        border-top-style: none;
      }
      
      .player1 {
        display: inline-block;
        width: 24px;
        height: 24px;
        background: green;
      }
      
      .player2 {
        display: inline-block;
        width: 24px;
        height: 24px;
        background: red;
      }
      
      .game-score {
        margin-left: 4px;
        position: absolute;
        top: 50%;
        height: 24px;
        bottom: -12px;
        display: inline-block;
      }
      
      .move-count {
        color: #bbb;
        margin-left: 3px;
        font-size: 80%;
      }
      
      .detail-graph {
        border: 2px solid black;
      }
      
      .detail-graph:focus {
        border: 2px solid blue;
      }
      
      .detail-game {
        border: 2px solid black;
        margin-left: 32px;
      }
    </style>
  </head>
  <body>
    <script>
      "use strict";
      
      function erf(x) {
        if(x >= 0) {
          return 1 - 1 / Math.pow(1 + 0.278393*x + 0.230389*x*x + 0.000972*x*x*x + 0.078108*x*x*x*x, 4);
        }
        return -erf(-x);
      }
      
      function los(wins, losses) {
        var sum = wins + losses
        if(sum > 0) {
          return 0.5 * (1 + erf((wins - losses) / Math.sqrt(2 * sum)));
        }
        return 0;
      }
      
      function GameState(pos1, pos2) {
        var field = new Uint8Array(101*102);
        var i;
        for(i = 0; i < 101; ++i) {
          field[i] = 3;
          field[i+101*101] = 3;
          field[201+i*101] = 3;
        }
        var players = [pos1, pos2].map(function(p, i) {
          if(typeof(pos1) !== 'number') p = p.x + (p.y + 1) * 101;
          field[p] = i + 1;
          return {
            startPos: p,
            pos: p,
            score: 1,
            moves: 0
          };
        });
        var moveIndex = 0;
        var moves = new Uint8Array(10000);
        var directions = {up: 0, left: 1, down: 2, right: 3};
        var offsets = [-101, -1, 101, 1];
        
        this.addMove = function(playerIndex, direction) {
          if(moveIndex >= 10000) {
            return -1;
          }
          var cmd = ((playerIndex & 1) << 2) | (directions[direction] & 3);
          moves[moveIndex++] = cmd;
          return this.executeMove(cmd);
        };
        
        this.executeMove = function(cmd) {
          var playerIndex = cmd >> 2;
          var player = players[playerIndex];
          var newPos = player.pos + offsets[cmd & 3];
          var f = field[newPos];
          player.moves++;
          if(f === 0 || f === playerIndex + 1) {
            if(f === 0) {
              player.score++;
            }
            player.pos = newPos;
            field[newPos] = playerIndex + 1;
            return 0;
          }
          return 1;
        };
        
        function posToXY(pos) {
          return { x: pos % 101, y: Math.floor(pos / 101) - 1 };
        }
        
        this.snapshot = function() {
          return {
            field: field,
            moves: moves,
            players: players,
            positions: [posToXY(players[0].pos), posToXY(players[1].pos)]
          };
        };
      }
      
      function Game(file1, file2, positions, reverse) {
        var self = this;
        var workers = !reverse ?
          [new GameWorker(0, file1), new GameWorker(1, file2)] :
          [new GameWorker(1, file2), new GameWorker(0, file1)];
        var state = !reverse ? new GameState(positions[0], positions[1]) : new GameState(positions[1], positions[0]);

        function endGame() {
          if(self.onResult) {
            self.onResult(state.snapshot());
          }
          self.terminate();
        }
        
        self.terminate = function() {
          for(var i = 0; i < 2; ++i) {
            if(workers[i]) {
              workers[i].terminate();
              workers[i] = null;
            }
          }
        }
        
        function GameWorker(index, file) {
          var self = this;

          var url = window.URL.createObjectURL(file);
          var worker = new Worker(url);
          window.URL.revokeObjectURL(url);
          
          self.terminate = function() {
            worker.terminate();
          };
          
          var id = 1;
          
          worker.onmessage = function(event) {
            if(event.data.id === id) {
              id = Math.random();
              var result = state.addMove(index, event.data.direction);
              if(result < 0) {
                endGame();
              } else {
                worker.postMessage({id: id, done: result === 0});
              }
            }
          };
          
          worker.postMessage({id: id});
        }
      }
      
      function Match(file1, file2) {
        var self = this;
        var game = null;
        var score = [0, 0];
        var reverse = false;
        var positions;
        
        startNewGame();
        
        function startNewGame() {
          if(game) {
            game.terminate();
          }
          if(!reverse) {
            positions = randomizePositions();
          }
          game = new Game(file1, file2, positions, reverse);
          reverse = !reverse;
          game.onResult = function(snapshot) {
            if(snapshot.players[0].score > snapshot.players[1].score) {
              score[0]++;
            } else {
              score[1]++;
            }
            if(self.onScoreChange) {
              self.onScoreChange(score, snapshot);
            }
            startNewGame();
          }
        }
        
        function randomizePositions() {
          function one() { return {x: Math.floor(Math.random() * 100), y: Math.floor(Math.random() * 100)}; }
          return [one(), one()];
        }
        
        self.stop = function() {
          if(game) {
            game.terminate();
            game = null;
          }
        };
        
        self.isStopped = function() { return game === null; }
      }
      
      var GameView = React.createClass({
        draw: function() {
          var ctx = this.refs.canvas.getDOMNode().getContext('2d');
          var imageData = ctx.getImageData(0, 0, 100, 100);
          var data = imageData.data;
          var field = this.props.game.field;
          var i1 = 101;
          var i2 = 0;
          for(var y = 0; y < 100; ++y) {
            for(var x = 0; x < 100; ++x) {
              switch(field[i1]) {
                case 0:
                  data[i2+0] = 240;
                  data[i2+1] = 240;
                  data[i2+2] = 240;
                  break;
                case 1:
                  data[i2+0] = 64;
                  data[i2+1] = 192;
                  data[i2+2] = 64;
                  break;
                case 2:
                  data[i2+0] = 192;
                  data[i2+1] = 64;
                  data[i2+2] = 64;
                  break;
              }
              data[i2 + 3] = 255;
              i2 += 4;
              i1++;
            }
            i1++;
          }
          ctx.putImageData(imageData, 0, 0);
        },
        componentDidMount: function() { this.draw(); },
        componentDidUpdate: function() { this.draw(); },
        shouldComponentUpdate: function(nextProps, nextState) { return this.props.id !== nextProps.id; },
        moveCountString: function() {
          var d = this.props.game.players[0].moves - this.props.game.players[1].moves;
          if(d > -20 && d < 20) return '=';
          if(d > 0) {
            if(d < 40) return '+';
            if(d < 80) return '++';
            if(d < 160) return '+++';
            if(d < 320) return '+++!';
            if(d < 640) return '++!!';
            return '+!!!';
          }
          if(d > -40) return '-';
          if(d > -80) return '--';
          if(d > -160) return '---';
          if(d > -320) return '---!';
          if(d > -640) return '--!!';
          return '-!!!';
        },
        onClick: function() {
          if(this.props.onSelect) {
            this.props.onSelect(this.props.game);
          }
        },
        render: function() {
          return React.DOM.div({
            className: 'game',
            onClick: this.onClick,
            children: [
              React.DOM.canvas({
                className: 'game-view',
                width: 100, height: 100, key: this.props.id, ref: 'canvas'}),
              React.DOM.div({
                className: 'game-result',
                children: [
                  React.DOM.div({
                    className: this.props.game.players[0].score > this.props.game.players[1].score ? 'player1' : 'player2'
                  }),
                  React.DOM.div({
                    className: 'game-score',
                    children: [
                      (this.props.game.players[0].score - this.props.game.players[1].score).toString() + ' ',
                      React.DOM.span({className: 'move-count', children: this.moveCountString()})
                    ]
                  })
                ]
              })
            ]
          });
        }
      });
      
      var DetailGraph = React.createClass({
        draw: function() {
          var canvas = this.getDOMNode()
          var w = canvas.width, h = canvas.height;
          canvas.width = w;
          var ctx = canvas.getContext('2d');
          
          var scores = [];
          var moves = [];
          var game = new GameState(this.props.game.players[0].startPos, this.props.game.players[1].startPos);
          
          var i;
          for(i = 0; i < 10000; ++i) {
            game.executeMove(this.props.game.moves[i]);
            var s = game.snapshot();
            scores[i] = s.players[0].score - s.players[1].score;
            moves[i] = s.players[0].moves - s.players[1].moves;
          }
          
          function graph(data, color) {
            var i;
            var max = 0;
            for(i = data.length - 1; i >= 0; --i) {
              max = Math.max(max, Math.abs(data[i]));
            }
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            for(var x = 1; x <= w; ++x) {
              i = Math.floor(x * (data.length - 1) / w);
              var y = (h - data[i] / max * h) / 2;
              ctx.lineTo(x, y);
            }
            ctx.strokeStyle = color;
            ctx.stroke();
          }
          
          ctx.beginPath();
          ctx.moveTo(0, h / 2);
          ctx.lineTo(w, h / 2);
          ctx.strokeStyle = '#ccc';
          ctx.stroke();
          
          graph(moves, '#66c');
          graph(scores, '#282');
          
          if(this.props.pos !== undefined) {
            var x = w * this.props.pos / (this.props.game.moves.length - 1);
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, h);
            ctx.strokeStyle = '#f88';
            ctx.stroke();
          }
        },
        onClick: function(event) {
          var x = event.clientX - event.target.getBoundingClientRect().left;
          var index = Math.floor(x * (this.props.game.moves.length - 1) / this.getDOMNode().width);
          if(this.props.onUpdatePos) {
            this.props.onUpdatePos(index);
          }
        },
        onKeyDown: function(event) {
          if(this.props.onUpdatePos) {
            var offset = event.ctrlKey ? 100 : (event.shiftKey ? 10 : 1);
            if(event.key === 'ArrowLeft') {
              this.props.onUpdatePos(Math.max(0, this.props.pos - offset));
              event.preventDefault();
            } else if(event.key === 'ArrowRight') {
              this.props.onUpdatePos(Math.min(10000, this.props.pos + offset));
              event.preventDefault();
            }
          }
        },
        componentDidMount: function() { this.draw(); },
        componentDidUpdate: function() { this.draw(); },
        render: function() {
          return React.DOM.canvas({
            className: 'detail-graph',
            onClick: this.onClick,
            onKeyDown: this.onKeyDown,
            tabIndex: '0',
            width: 600,
            height: 400,
          });
        }
      });
      
      var DetailGame = React.createClass({
        draw: function() {
          var canvas = this.getDOMNode()
          var w = canvas.width, h = canvas.height;
          canvas.width = w;
          var ctx = canvas.getContext('2d');

          var field = this.props.game.field;
          for(var y = 0; y < 100; ++y) {
            for(var x = 0; x < 100; ++x) {
              var v = field[x + (y + 1) * 101];
              if(v !== 0) {
                ctx.fillStyle = v === 1 ? '#4c4' : '#c44';
                ctx.fillRect(x * 4, y * 4, 4, 4);
              }
            }
          }
          
          ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
          this.props.game.positions.forEach(function(p) {
            ctx.fillRect(p.x * 4, p.y * 4, 4, 4);
          });
        },
        componentDidMount: function() { this.draw(); },
        componentDidUpdate: function() { this.draw(); },
        render: function() {
          return React.DOM.canvas({
            className: 'detail-game',
            width: 400,
            height: 400
          });
        }
      });
      
      var DetailView = React.createClass({
        getInitialState: function() { return this.makeState(10000); },
        updatePos: function(pos) { this.setState(this.makeState(pos)); },
        makeState: function(pos) {
          var game = new GameState(this.props.game.players[0].startPos, this.props.game.players[1].startPos);
          var i;
          for(i = 0; i < pos; ++i) {
            game.executeMove(this.props.game.moves[i]);
          }
          return {pos: pos, snapshot: game.snapshot()};
        },
        gameInfo: function() {
          var p = this.state.snapshot.players;
          return 'Score: ' + p[0].score + ' - ' + p[1].score + ' = ' + (p[0].score - p[1].score) +
            '\nMoves: ' + p[0].moves + ' - ' + p[1].moves + ' = ' + (p[0].moves - p[1].moves);
        },
        render: function() {
          return React.DOM.div({children: [
            DetailGraph({game: this.props.game, pos: this.state.pos, onUpdatePos: this.updatePos}),
            DetailGame({game: this.state.snapshot}),
            React.DOM.pre({children: this.gameInfo() })
          ]});
        }
      });
      
      var MatchView = React.createClass({
        getInitialState: function() {
          return {gameId: 0, score: [0, 0], games: []};
        },
        start: function() {
          var match = new Match(this.props.file1, this.props.file2);
          this.setState({match: match, score: [0, 0], gameId: 0, games: []});
          match.onScoreChange = this.scoreChange;
        },
        stop: function() {
          this.state.match.stop();
          this.setState({match: null, score: this.state.score});
        },
        scoreChange: function(score, gameData) {
          var games = this.state.games;
          games[this.state.gameId % 20] = {id: this.state.gameId++, game: gameData};
          this.setState({score: score, games: games});
        },
        openDetail: function(state) {
          this.setState({detailState: state});
        },
        closeDetail: function() {
          this.setState({detailState: null});
        },
        gameView: function(g) {
          return GameView({id: g.id, game: g.game, onSelect: this.openDetail});
        },
        render: function() {
          if(!this.props.file1 || !this.props.file2) {
            return React.DOM.div({children: 'Please select two workers'});
          } else if(this.state.match) {
            this.state.match.onScoreChange = this.scoreChange;
          }
          return React.DOM.div({children: [
            React.DOM.div({children: [
              React.DOM.span({className: 'name', children: [this.props.file1.name]}),
              React.DOM.div({className: 'player1'}),
              React.DOM.span({className: 'match-score', children: [this.state.score[0] + ' - ' + this.state.score[1]]}),
              React.DOM.div({className: 'player2'}),
              React.DOM.span({className: 'name', children: [this.props.file2.name]}),
              ' (LOS ' + (los(this.state.score[0], this.state.score[1]) * 100).toFixed(2) + '%)'
            ]}),
            React.DOM.button({
              type: 'button',
              onClick: this.state.match ? this.stop : this.start,
              children: this.state.match ? 'Stop' : 'Start'
            }),
            this.state.detailState ?
              React.DOM.div({children: [
                React.DOM.a({href: '#', onClick: this.closeDetail, children: '< Back'}),
                DetailView({game: this.state.detailState})
              ]}) :
              React.DOM.div({children: this.state.games.map(this.gameView)})
          ]});
        }
      });
      
      var FileSelector = React.createClass({
        handleChange: function(event) {
          if(this.props.onChange) {
            this.props.onChange(event.target.files[0]);
          }
        },
        render: function() {
          return React.DOM.div({children: [
            React.DOM.input({type: 'file', onChange: this.handleChange})
          ]});
        }
      });
    
      var Runner = React.createClass({
        getInitialState: function() {
          return {file1: null, file2: null};
        },
        handleFileChange: function(key, file) {
          var o = {};
          o[key] = file;
          this.setState(o);
        },
        render: function() {
          return React.DOM.div({children: [
            React.DOM.div({className: 'workers', children: [
              FileSelector({onChange: this.handleFileChange.bind(this, 'file1')}),
              FileSelector({onChange: this.handleFileChange.bind(this, 'file2')}),
            ]}),
            MatchView(this.state),
          ]});
        }
      });
      React.renderComponent(Runner({}), document.body);
    </script>
  </body>
</html>
